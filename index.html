<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/style.min.css">
  <title>Document</title>
</head>
<body>
  <section class="typeArea">
    <div class="title">
      <h1>카톡 메이커</h1>
      <p>이것은 픽션 민원 카톡을 만들기 위하여 만들어진 페이지입니다.</p>
    </div>
    <textarea name="text" id="inputText" onInput="this.parentNode.dataset.replicatedValue = this.value" placeholder="여기에 입력하세요"></textarea>

    <button onclick="parseText()">생성하기</button>

  </section>
  <section class="kakao">
    <div id="output"></div>
  </section>

  <section class="setting">
    <h2>오른쪽 말풍선 설정</h2>
    <div id="buttons"></div>
  </section>
  
  <script>

    // textarea에서 텍스트 가져오기
    let outputDiv = document.getElementById("output");

    
    let settingArea = document.querySelector('.setting');
    let btnArea = settingArea.querySelector('#buttons');
    let btns = [];

    function parseText() {
      outputDiv.innerHTML = " ";
      let messages = document.getElementById("inputText").value.split('\n');

      let result = [];
      let current = null;

      messages.forEach(msg => {
        let match = msg.match(/\[([^\]]+)\] (.+)/); // `[이름] 시간` 형식 추출

        if (match) {
          // 새 대화 시작: 기존 대화를 저장 후 새로운 객체 생성
          if (current) result.push(current);

          current = { name: match[1], time: match[2], messages: [] };
        } else if (current) {
          // 메시지 추가
          let trimmedMsg = msg.trim(); // 앞뒤 공백 제거
          if (trimmedMsg) current.messages.push(trimmedMsg); // 빈 줄이 아닐 때만 추가
        }
      });
      if (current) result.push(current);
      
      result.forEach(el => {
        let name = document.createElement("div");
        let texts = document.createElement("div");
        let time = document.createElement("span");

        name.innerText = el.name;

        el.messages.forEach((msg, i)=> {
          let p = document.createElement("p");
          let cover = document.createElement('div');
          p.innerText = msg;
          if (i === el.messages.length - 1) { // 마지막거라면
            time.innerHTML = el.time;
            cover.appendChild(p);
            cover.appendChild(time);
            texts.appendChild(cover);
            if (el.messages.length >1 ){ p.classList +="endLine";}
          } else {
            texts.appendChild(p);
          }
        });
        
        name.classList += "name";
        texts.classList += "texts";
        outputDiv.appendChild(name);
        outputDiv.appendChild(texts);
      });

      result.forEach(el => {
        btns.push(el.name)
        btns = [...new Set(btns)];
      })
      btnArea.innerHTML = '';
      btns.forEach(el => {
        btnArea.innerHTML += `<button onClick="test(this)" value="${el}">${el}</button>`;
      })
      console.log(btns);
    }
    parseText();

  </script>

  <script>
    function test(btn) {
      let names = document.querySelectorAll('.name');
      let texts = document.querySelectorAll('.texts');
      names.forEach(el => {
        if (el.innerText === btn.value) {
          el.classList.add('right');
          el.nextSibling.classList.add('right');
        } else {
          el.classList.remove('right');
          el.nextSibling.classList.remove('right');
        }
      })
    }
  </script>

</body>
</html>